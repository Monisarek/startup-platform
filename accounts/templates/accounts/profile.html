{% extends 'accounts/base.html' %}
{% load static %}
{% load file_tags %}
{% load accounts_extras %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è{% endblock %}

{% block head_extra %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'accounts/css/profile.css' %}?v={% now 'U' %}" />
{% endblock %}

{% block content %}
<div class="profile-page-wrapper">
    <img class="profile-main-banner" src="{% static 'accounts/images/profile/profile_spacebg.webp' %}" alt="–ë–∞–Ω–Ω–µ—Ä –ø—Ä–æ—Ñ–∏–ª—è" />
    <div class="profile-content-container">
        <div class="profile-sidebar">
            <div class="profile-sidebar-user-info-block">
                <div class="profile-sidebar-avatar-wrapper" id="avatarClickableArea" style="cursor: pointer;" title="–ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä">
                    <img class="profile-sidebar-avatar-img" src="{% if user.get_profile_picture_url %}{{ user.get_profile_picture_url }}{% else %}{% static 'accounts/images/avatars/default_avatar_ufo.png' %}{% endif %}" alt="–ê–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" />
                    {% if is_own_profile %}
                    <button class="profile-sidebar-avatar-delete" id="deleteAvatarBtn" title="–£–¥–∞–ª–∏—Ç—å –∞–≤–∞—Ç–∞—Ä" {% if not user.get_profile_picture_url %}style="display: none;"{% endif %}>
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4L4 12M4 4L12 12" stroke="white" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </button>
                    {% endif %}
                </div>
                <div class="profile-sidebar-text-details">
                    <div class="profile-sidebar-name-role">
                        <div class="profile-sidebar-name">
                            <span>{{ user.first_name|default:"–ò–º—è" }}</span>
                            <span>{{ user.last_name|default:"–§–∞–º–∏–ª–∏—è" }}</span>
                        </div>
                        <div class="profile-sidebar-role">
                            <span>
                                {% if user.role.role_name == "startuper" %}–°—Ç–∞—Ä—Ç–∞–ø–µ—Ä
                                {% elif user.role.role_name == "investor" %}–ò–Ω–≤–µ—Å—Ç–æ—Ä
                                {% elif user.role.role_name == "moderator" %}–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä
                                {% elif user.role.role_name == "administrator" %}–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
                                {% else %}{{ user.role.role_name|default:"–†–æ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω–∞" }}{% endif %}
                            </span>
                        </div>
                        <div class="profile-sidebar-id">
                            <span>ID {{ user.user_id|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</span>
                            <div class="profile-sidebar-copy-icon" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å ID">
                                <div class="profile-sidebar-copy-icon-inner1"></div>
                                <div class="profile-sidebar-copy-icon-inner2"></div>
                            </div>
                        </div>
                    </div>
                    <div class="profile-sidebar-bio">{{ user.bio|default:"–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç."}}</div>
                    {% if user.website_url %}
                    <div class="profile-sidebar-website">
                        <img src="{% static 'accounts/images/profile/Globe_Line.svg' %}" alt="Website" class="profile-sidebar-website-icon-img">
                        <a href="{{ user.website_url }}" target="_blank" class="profile-sidebar-website-link">{{ user.website_url }}</a>
                    </div>
                    {% endif %}
                    {% if user.social_links.telegram %}
                    <div class="profile-sidebar-social-link">
                        <span>Telegram: <a href="https://t.me/{{ user.social_links.telegram|slice:'1:' }}" target="_blank">{{ user.social_links.telegram }}</a></span>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="profile-sidebar-social-icons-round">
                <div class="profile-sidebar-social-icon-round-item">
                    <img src="{% static 'accounts/images/profile/share_icon.svg' %}" alt="Share" class="profile-sidebar-social-icon-img">
                </div>
                <div class="profile-sidebar-social-icon-round-item">
                     <img src="{% static 'accounts/images/profile/dots.svg' %}" alt="More options" class="profile-sidebar-social-icon-img">
                </div>
            </div>
            
            {% if is_own_profile %}
            <div class="profile-avatar-upload-section" style="display: none;">
                <h4>–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É</h4>
                <form method="post" enctype="multipart/form-data" id="avatarUploadForm" class="avatar-upload-form">
                    {% csrf_token %}
                    <input type="file" name="avatar" accept="image/png,image/jpeg" required id="id_avatar_input" class="file-input-hidden">
                    <button type="button" onclick="document.getElementById('id_avatar_input').click();" class="btn btn-secondary choose-file-btn">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</button>
                    <div id="fileNameDisplay" class="file-name-display">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
                    <button type="submit" class="btn btn-primary upload-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                </form>
            </div>
            {% endif %}

            {% if user.role.role_name == "startuper" %}
            <a href="{% url 'my_startups' %}" class="profile-sidebar-my-galaxy-btn">
                <div class="profile-sidebar-my-galaxy-btn-text">–ú–æ—è –ì–∞–ª–∞–∫—Ç–∏–∫–∞</div>
            </a>
            {% elif user.role.role_name == "investor" %}
            <a href="{% url 'investments' %}" class="profile-sidebar-my-galaxy-btn">
                <div class="profile-sidebar-my-galaxy-btn-text">–ú–æ—è –ì–∞–ª–∞–∫—Ç–∏–∫–∞</div>
            </a>
            {% endif %}
            
            <div class="profile-sidebar-social-icons-row">
                {% if user.vk_url %}
                <a href="{{ user.vk_url }}" target="_blank" class="profile-sidebar-social-link">
                    <img class="profile-sidebar-social-icon-row-item-img" src="{% static 'accounts/images/profile/vk_icon_social.svg' %}" alt="VK" />
                </a>
                {% else %}
                <img class="profile-sidebar-social-icon-row-item-img profile-sidebar-social-icon-disabled" src="{% static 'accounts/images/profile/vk_icon_social.svg' %}" alt="VK" />
                {% endif %}
                {% if user.linkedin_url %}
                <a href="{{ user.linkedin_url }}" target="_blank" class="profile-sidebar-social-link">
                    <img class="profile-sidebar-social-icon-row-item-img" src="{% static 'accounts/images/profile/linkedin_icon_social.svg' %}" alt="LinkedIn" />
                </a>
                {% else %}
                <img class="profile-sidebar-social-icon-row-item-img profile-sidebar-social-icon-disabled" src="{% static 'accounts/images/profile/linkedin_icon_social.svg' %}" alt="LinkedIn" />
                {% endif %}
            </div>
            <div class="profile-sidebar-divider"></div>
            <div class="profile-sidebar-date-joined">–ù–∞ –ø–ª–æ—â–∞–¥–∫–µ —Å {{ user.created_at|date:"d M Y"|default:"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ" }}</div>
        </div>

        <div class="profile-main-content">
            {% if is_own_profile %}
            <div class="profile-main-edit-btn-container">
                <a href="#" class="profile-main-edit-btn" id="editProfileBtn">
                    <div class="profile-main-edit-btn-text">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</div>
                    <img src="{% static 'accounts/images/profile/Edit_Line.svg' %}" alt="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" class="profile-main-edit-btn-icon"/>
                </a>
            </div>
            {% endif %}
            <div id="profileViewBlock">
                <div class="profile-main-startups-section">
                    <div class="profile-main-tabs">
                        <div class="profile-main-tab-item active-tab" data-tab="startups">–°—Ç–∞—Ä—Ç–∞–ø—ã</div>
                        <div class="profile-main-tab-item" data-tab="news">–ù–æ–≤–æ—Å—Ç–∏</div>
                    </div>
                    
                    <div class="profile-main-content-tab active-content" id="startupsContent">
                        {% if startups_page %}
                            {% for startup in startups_page %}
                                <div class="profile-main-startup-card-item">
                                    <div class="profile-main-startup-card-content">
                                        <div class="profile-main-startup-info">
                                            <div class="profile-main-startup-name">{{ startup.title }}</div>
                                            <div class="profile-main-startup-rating-reviews">
                                                <span class="profile-main-startup-rating">–†–µ–π—Ç–∏–Ω–≥ {{ startup.get_average_rating|floatformat:1 }}/5 ({{ startup.total_voters }})</span>
                                                <div class="profile-main-startup-reviews">
                                                    <img src="{% static 'accounts/images/profile/chat_icon.svg' %}" alt="Reviews" class="profile-main-startup-review-icon-img">
                                                    <span>{{ startup.comment_count }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="profile-main-startup-category-progress">
                                            <div class="profile-main-startup-category-tag">
                                                {% if startup.direction.direction_name == "Fastfood" %}–§–∞—Å—Ç—Ñ—É–¥
                                                {% elif startup.direction.direction_name == "Technology" %}–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
                                                {% elif startup.direction.direction_name == "Finance" %}–§–∏–Ω–∞–Ω—Å—ã
                                                {% else %}{{ startup.direction.direction_name|translate_category|default:"–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" }}
                                                {% endif %}
                                            </div>
                                            <div class="progress-bar-and-text-container">
                                                <div class="profile-main-startup-progress-bar-bg">
                                                    <div class="profile-main-startup-progress-bar-fg" style="width: {{ startup.get_progress_percentage }}%"></div>
                                                </div>
                                                <span class="profile-main-startup-progress-text">{{ startup.get_progress_percentage }}%</span>
                                            </div>
                                        </div>
                                        <a href="{% url 'startup_detail' startup.startup_id %}" class="btn btn-primary profile-main-startup-details-btn">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                                    </div>
                                    <img class="profile-main-startup-image" 
                                         src="{% if startup.logo_urls and startup.logo_urls.0 %}{% get_file_url_tag startup.logo_urls.0 startup.startup_id 'logo' %}{% else %}{% static 'accounts/images/profile/Rectangle_4196.png' %}{% endif %}" 
                                         alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ä—Ç–∞–ø–∞" />
                                </div>
                                {% if not forloop.last %}
                                    <div class="profile-main-startup-list-divider"></div>
                                {% endif %}
                            {% endfor %}
                            
                            {% if startups_page.paginator.num_pages > 1 %}
                                <div class="pagination">
                                    {% if startups_page.has_previous %}
                                        <a href="?startups_page={{ startups_page.previous_page_number }}{% if news_page.number != 1 %}&news_page={{ news_page.number }}{% endif %}" class="pagination-link">¬´ –ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
                                    {% endif %}
                                    {% for num in startups_page.paginator.page_range %}
                                        {% if num == startups_page.number %}
                                            <span class="pagination-link active">{{ num }}</span>
                                        {% else %}
                                            <a href="?startups_page={{ num }}{% if news_page.number != 1 %}&news_page={{ news_page.number }}{% endif %}" class="pagination-link">{{ num }}</a>
                                        {% endif %}
                                    {% endfor %}
                                    {% if startups_page.has_next %}
                                        <a href="?startups_page={{ startups_page.next_page_number }}{% if news_page.number != 1 %}&news_page={{ news_page.number }}{% endif %}" class="pagination-link">–°–ª–µ–¥—É—é—â–∞—è ¬ª</a>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="profile-main-no-startups">–ù–µ—Ç —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤</div>
                        {% endif %}
                    </div>

                    <div class="profile-main-content-tab" id="newsContent">
                        <div class="profile-news-items-container">
                            {% if news_page %}
                                {% for news in news_page %}
                                    <a href="{% url 'news_detail' news.article_id %}" class="profile-news-card-link">
                                        <div class="profile-news-card-item">
                                            <img src="{% if news.get_image_url %}{{ news.get_image_url }}{% else %}{% static 'accounts/images/startups/inside_cards_background.webp' %}{% endif %}" alt="–ù–æ–≤–æ—Å—Ç—å"/>
                                            <div class="profile-news-card-title">{{ news.title }}</div>
                                            <div class="profile-news-card-description">{{ news.content|truncatechars:100 }}</div>
                                        </div>
                                    </a>
                                {% endfor %}
                                
                                {% if news_page.paginator.num_pages > 1 %}
                                    <div class="pagination">
                                        {% if news_page.has_previous %}
                                            <a href="?news_page={{ news_page.previous_page_number }}{% if startups_page.number != 1 %}&startups_page={{ startups_page.number }}{% endif %}" class="pagination-link">¬´ –ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
                                        {% endif %}
                                        {% for num in news_page.paginator.page_range %}
                                            {% if num == news_page.number %}
                                                <span class="pagination-link active">{{ num }}</span>
                                            {% else %}
                                                <a href="?news_page={{ num }}{% if startups_page.number != 1 %}&startups_page={{ startups_page.number }}{% endif %}" class="pagination-link">{{ num }}</a>
                                            {% endif %}
                                        {% endfor %}
                                        {% if news_page.has_next %}
                                            <a href="?news_page={{ news_page.next_page_number }}{% if startups_page.number != 1 %}&startups_page={{ startups_page.number }}{% endif %}" class="pagination-link">–°–ª–µ–¥—É—é—â–∞—è ¬ª</a>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="profile-main-no-news">–ù–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div id="profileEditBlock" class="profile-edit-animated" style="display:none; opacity:0; pointer-events:none;">
                <div class="profile-edit-wrapper">
                    <div class="profile-edit-header-block">
                        <button class="profile-edit-back-btn" id="profileEditBackBtn" type="button">
                            <svg width="24" height="24" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="profile-edit-back-icon">
                              <path d="M12.6668 7.99992H3.3335M3.3335 7.99992L8.00016 12.6666M3.3335 7.99992L8.00016 3.33325" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span>–ù–∞–∑–∞–¥</span>
                        </button>
                        <div class="profile-edit-title">–ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</div>
                        <div class="profile-edit-desc">–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å URL —Å–∞–π—Ç–∞ –∏ –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—à–∏ —Å–æ—Ü —Å–µ—Ç–∏, —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–º–æ–≥–ª–∏ –±–æ–ª—å—à–µ —É–∑–Ω–∞—Ç—å –æ –≤–∞—Å</div>
                    </div>
                    <div class="profile-edit-main-row">
                        <div class="profile-edit-avatar-col">
                            <div class="profile-edit-avatar-wrapper">
                                <img src="{% if user.get_profile_picture_url %}{{ user.get_profile_picture_url }}{% else %}{% static 'accounts/images/avatars/default_avatar_ufo.png' %}{% endif %}" alt="–ê–≤–∞—Ç–∞—Ä" class="profile-edit-avatar-img"/>
                            </div>
                            <div class="profile-edit-avatar-info">
                                <div class="profile-edit-avatar-label">–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è</div>
                                <div class="profile-edit-avatar-hint">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è <br>–ø–æ —Ä–∞–∑–º–µ—Ä—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è 400—Ö400 üôå</div>
                                <div class="profile-edit-avatar-btn" onclick="document.getElementById('id_avatar_input').click();">–û–±–Ω–æ–≤–∏—Ç—å</div>
                            </div>
                        </div>
                        <div class="profile-edit-fields-col">
                            <form method="post" id="profileEditForm" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="hidden" name="edit_profile" value="1">
                                <div class="profile-edit-section">
                                    <div class="profile-edit-section-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è</div>
                                    <div class="profile-edit-field">
                                        <div class="profile-edit-field-label">–ò–º—è</div>
                                        {{ form.first_name }}
                                    </div>
                                    <div class="profile-edit-field">
                                        <div class="profile-edit-field-label">–§–∞–º–∏–ª–∏—è</div>
                                        {{ form.last_name }}
                                    </div>
                                    <div class="profile-edit-field">
                                        <div class="profile-edit-field-label">–°–∞–π—Ç</div>
                                        {{ form.website_url }}
                                    </div>
                                    <div class="profile-edit-field">
                                        <div class="profile-edit-field-label">–û —Å–µ–±–µ</div>
                                        {{ form.bio }}
                                        <div class="profile-edit-char-counter" id="bioCounter">50/50</div>
                                    </div>
                                </div>
                                <div class="profile-edit-section" style="margin-top:40px;">
                                    <div class="profile-edit-section-title">–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏</div>
                                    <div class="profile-edit-field">
                                        <div class="profile-edit-field-label">TELEGRAM</div>
                                        <input type="text" name="telegram" value="{{ form.telegram.value|default:'' }}" class="profile-edit-input" placeholder="@username">
                                    </div>
                                    <div class="profile-edit-field">
                                        <div class="profile-edit-field-label">VK</div>
                                        <input type="text" name="vk_url" value="{{ form.vk_url.value|default:'' }}" class="profile-edit-input" placeholder="https://vk.com/username">
                                    </div>
                                    <div class="profile-edit-field">
                                        <div class="profile-edit-field-label">LINKEDIN</div>
                                        <input type="text" name="linkedin_url" value="{{ form.linkedin_url.value|default:'' }}" class="profile-edit-input" placeholder="https://linkedin.com/in/username">
                                    </div>
                                </div>
                                <div class="profile-edit-hint">–ß—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –Ω–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π".</div>
                                <div class="profile-edit-divider"></div>
                                <div class="profile-edit-actions">
                                    <button type="submit" class="profile-edit-save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π</button>
                                    <div class="profile-edit-clear-btn" id="clearFormBtn">
                                        <img src="{% static 'accounts/images/profile/close_circle.svg' %}" alt="–û—á–∏—Å—Ç–∏—Ç—å" class="profile-edit-clear-icon"/>
                                        <span>–û—á–∏—Å—Ç–∏—Ç—å</span>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if show_role_selection %}
<div class="modal" style="position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);z-index:1000;display:block;">
  <div class="modal-content" style="background:#fff;margin:15% auto;padding:20px;border-radius:8px;width:80%;max-width:500px;text-align:center;box-shadow:0 4px 8px rgba(0,0,0,.2);">
    <h2 style="margin-top:0;color:#333;font-size:24px;">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É —Ä–æ–ª—å</h2>
    <p style="color:#666;margin-bottom:20px;font-size:16px;">–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É —Ä–æ–ª—å. –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤–∞—à–∏—Ö –ø—Ä–∞–≤ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –Ω–∞ —Å–∞–π—Ç–µ. –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏ –≤—ã —Å–º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤—Å–µ–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –ø—Ä–æ—Ñ–∏–ª—è.</p>
    <form method="POST" action="">
      {% csrf_token %}
      <select name="role_id" class="role-select" required style="padding:10px;margin:10px 0;width:100%;border:1px solid #ccc;border-radius:4px;font-size:16px;">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>
        <option value="1">–°—Ç–∞—Ä—Ç–∞–ø–µ—Ä</option>
        <option value="2">–ò–Ω–≤–µ—Å—Ç–æ—Ä</option>
      </select>
      <div class="modal-buttons" style="margin-top:20px;">
        <button type="submit" name="select_role" class="confirm" style="padding:10px 20px;margin:0 10px;border:none;border-radius:4px;cursor:pointer;font-size:16px;background-color:#4CAF50;color:#fff;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        <button type="button" class="cancel" onclick="window.location.href='/logout/'" style="padding:10px 20px;margin:0 10px;border:none;border-radius:4px;cursor:pointer;font-size:16px;background-color:#f44336;color:#fff;">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const avatarClickableArea = document.getElementById('avatarClickableArea');
    const avatarInput = document.getElementById('id_avatar_input');
    const avatarUploadForm = document.getElementById('avatarUploadForm');
    const deleteAvatarBtn = document.getElementById('deleteAvatarBtn');
    const editBtn = document.getElementById('editProfileBtn');
    const profileViewBlock = document.getElementById('profileViewBlock');
    const profileEditBlock = document.getElementById('profileEditBlock');
    const backBtn = document.getElementById('profileEditBackBtn');
    const clearBtn = document.getElementById('clearFormBtn');
    const profileEditForm = document.getElementById('profileEditForm');
    const bioInput = document.querySelector('#profileEditForm textarea[name="bio"]');
    const bioCounter = document.getElementById('bioCounter');

    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞
    function showEditBlock() {
        profileViewBlock.classList.add('profile-fade-out');
        setTimeout(() => {
            profileViewBlock.style.display = 'none';
            profileEditBlock.style.display = 'block';
            setTimeout(() => {
                profileEditBlock.style.opacity = 1;
                profileEditBlock.style.pointerEvents = 'auto';
                profileEditBlock.classList.add('profile-fade-in');
            }, 10);
        }, 300);
    }

    function hideEditBlock() {
        profileEditBlock.classList.remove('profile-fade-in');
        profileEditBlock.style.opacity = 0;
        profileEditBlock.style.pointerEvents = 'none';
        setTimeout(() => {
            profileEditBlock.style.display = 'none';
            profileViewBlock.style.display = 'block';
            profileViewBlock.classList.remove('profile-fade-out');
        }, 300);
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞
    if (avatarClickableArea && avatarInput && avatarUploadForm) {
        avatarClickableArea.addEventListener('click', function() {
            avatarInput.click();
        });

        avatarInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                avatarUploadForm.submit();
            }
        });
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –∞–≤–∞—Ç–∞—Ä–∞
    if (deleteAvatarBtn) {
        deleteAvatarBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–≤–∞—Ç–∞—Ä?')) {
                fetch("{% url 'delete_avatar' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.querySelector('.profile-sidebar-avatar-img').src = "{% static 'accounts/images/avatars/default_avatar_ufo.png' %}";
                        deleteAvatarBtn.style.display = 'none';
                        alert(data.message);
                    } else {
                        alert(data.error);
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞–≤–∞—Ç–∞—Ä–∞.');
                });
            }
        });
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
    if (editBtn && profileViewBlock && profileEditBlock) {
        editBtn.addEventListener('click', function(e) {
            e.preventDefault();
            showEditBlock();
        });
    }

    if (backBtn) {
        backBtn.addEventListener('click', function() {
            hideEditBlock();
        });
    }

    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            profileEditForm.reset();
            if (bioInput) {
                bioCounter.textContent = '50/50';
            }
        });
    }

    // –°—á—ë—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è bio
    if (bioInput && bioCounter) {
        function updateBioCounter() {
            const remaining = 50 - bioInput.value.length;
            bioCounter.textContent = `${remaining}/50`;
            if (remaining < 0) {
                bioCounter.style.color = 'red';
            } else {
                bioCounter.style.color = '';
            }
        }
        bioInput.addEventListener('input', updateBioCounter);
        updateBioCounter();
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    if (profileEditForm) {
        profileEditForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(profileEditForm);
            fetch("{% url 'profile' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.reload();
                } else {
                    alert(data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è.');
                    if (data.errors) {
                        console.log('–û—à–∏–±–∫–∏ —Ñ–æ—Ä–º—ã:', data.errors);
                    }
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è.');
            });
        });
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    const tabs = document.querySelectorAll('.profile-main-tab-item');
    const tabContents = document.querySelectorAll('.profile-main-content-tab');

    tabs.forEach(tab => {
        tab.addEventListener('click', function(event) {
            event.preventDefault();
            const currentActiveTab = document.querySelector('.profile-main-tab-item.active-tab');
            const currentActiveContent = document.querySelector('.profile-main-content-tab.active-content');
            const targetTabId = this.getAttribute('data-tab');
            const newActiveContent = document.getElementById(targetTabId + 'Content');
            if (currentActiveTab === this || !newActiveContent) return;
            if (currentActiveTab) currentActiveTab.classList.remove('active-tab');
            if (currentActiveContent) {
                currentActiveContent.classList.remove('active-content');
                currentActiveContent.classList.add('profile-fade-out');
                setTimeout(() => {
                    currentActiveContent.style.display = 'none';
                    currentActiveContent.classList.remove('profile-fade-out');
                    tabs.forEach(t => t.classList.remove('active-tab'));
                    tab.classList.add('active-tab');
                    newActiveContent.style.display = 'flex';
                    setTimeout(() => {
                        newActiveContent.classList.add('active-content');
                    }, 10);
                }, 300);
            } else {
                tabs.forEach(t => t.classList.remove('active-tab'));
                tab.classList.add('active-tab');
                newActiveContent.style.display = 'flex';
                setTimeout(() => {
                    newActiveContent.classList.add('active-content');
                }, 10);
            }
        });
    });

    function initializeActiveTab() {
        let initialActiveTab = document.querySelector('.profile-main-tab-item.active-tab');
        if (!initialActiveTab && tabs.length > 0) {
            initialActiveTab = tabs[0];
            initialActiveTab.classList.add('active-tab');
        }

        if (initialActiveTab) {
            const initialTargetTabId = initialActiveTab.getAttribute('data-tab');
            const initialActiveContent = document.getElementById(initialTargetTabId + 'Content');
            if (initialActiveContent) {
                tabContents.forEach(content => {
                    if (content !== initialActiveContent) {
                        content.style.display = 'none';
                        content.classList.remove('active-content');
                    }
                });
                initialActiveContent.style.display = 'flex';
                requestAnimationFrame(() => {
                    initialActiveContent.classList.add('active-content');
                });
            } else if (tabs.length > 0) {
                initialActiveTab.classList.remove('active-tab');
                tabs[0].classList.add('active-tab');
                const firstTabId = tabs[0].getAttribute('data-tab');
                const firstContent = document.getElementById(firstTabId + 'Content');
                if (firstContent) {
                    tabContents.forEach(content => {
                        content.style.display = 'none';
                        content.classList.remove('active-content');
                    });
                    firstContent.style.display = 'flex';
                    requestAnimationFrame(() => {
                        firstContent.classList.add('active-content');
                    });
                }
            }
        }
    }
    initializeActiveTab();
});
</script>
{% endblock %}